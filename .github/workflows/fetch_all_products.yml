name: Fetch India Products on OFF from Hugging Face

on:
  workflow_dispatch:  # manual trigger
jobs:
  fetch-and-save:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # allow push to repo
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"
      
      - name: Install dependencies
        run: pip install pandas pyarrow huggingface-hub
      
      - name: Fetch data and save CSV
        run: |
          python << 'EOF'
          import os
          import pandas as pd
          from datetime import datetime
          from huggingface_hub import hf_hub_download
          
          # --- Config ---
          REPO_ID = "openfoodfacts/product-database"
          DATE_STR = datetime.utcnow().strftime("%Y-%m-%d")
          README_PATH = "data/readme.md"
          
          # --- Download Parquet file from Hugging Face ---
          print("Downloading Parquet file from Hugging Face...")
          try:
              parquet_file = hf_hub_download(
                  repo_id=REPO_ID,
                  filename="products.parquet",
                  repo_type="dataset"
              )
              print(f"Downloaded to: {parquet_file}")
          except Exception as e:
              print(f"Error downloading file: {e}")
              exit(1)
          
          # --- Load and filter data ---
          print("Loading Parquet file...")
          df = pd.read_parquet(parquet_file)
          
          print(f"Total records in database: {len(df)}")
          
          # --- Filter for India products ---
          print("Filtering for India products...")
          
          # Filter conditions
          df_filtered = df[
              (df['code'].notna()) & (df['code'].astype(str).str.strip() != '') &
              (df['product_name'].notna()) & (df['product_name'].astype(str).str.strip() != '') &
              (df['countries_en'].notna()) & (df['countries_en'].str.contains('India', case=False, na=False))
          ].copy()
          
          # --- Select required columns ---
          columns_to_extract = [
              'code', 'product_name', 'brands', 'categories', 
              'energy-kcal_100g', 'carbohydrates_100g', 'sugars_100g', 'fiber_100g',
              'proteins_100g', 'fat_100g', 'saturated-fat_100g', 'salt_100g',
              'nova_group', 'nutriscore_grade', 'url', 'last_modified_datetime',
              'ingredients_text'
          ]
          
          # Only keep columns that exist in the dataframe
          available_columns = [col for col in columns_to_extract if col in df_filtered.columns]
          missing_columns = [col for col in columns_to_extract if col not in df_filtered.columns]
          
          if missing_columns:
              print(f"Warning: Following columns not found in database: {missing_columns}")
          
          df_result = df_filtered[available_columns]
          
          # --- Save CSV ---
          if df_result.empty:
              print("No records found. Exiting without saving.")
              exit(0)
          
          record_count = len(df_result)
          csv_filename = f"all_{DATE_STR}_{record_count}.csv"
          csv_path = os.path.join("data", csv_filename)
          os.makedirs("data", exist_ok=True)
          
          df_result.to_csv(csv_path, index=False)
          print(f"Saved {record_count} records to {csv_path}")
          
          # --- Update README.md with a markdown table ---
          note = f"| {DATE_STR} | {record_count} | `{csv_filename}` |\n"
          
          if os.path.exists(README_PATH):
              with open(README_PATH, "a", encoding="utf-8") as f:
                  f.write(note)
          else:
              with open(README_PATH, "w", encoding="utf-8") as f:
                  f.write("# Data Log\n\n")
                  f.write("| Date | Record Count | File |\n")
                  f.write("|------|--------------|------|\n")
                  f.write(note)
          
          print(f"Updated {README_PATH}")
          EOF
      
      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          git commit -m "Fetched all India products on $(date -u +'%Y-%m-%d')" || echo "No changes"
          git push
