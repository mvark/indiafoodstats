name: Fetch All India Products

on:
  workflow_dispatch:  # manual trigger

jobs:
  fetch-and-save:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # allow push to repo

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install pandas requests

      - name: Fetch data and save CSV
        run: |
          python << 'EOF'
          import os
          import requests
          import pandas as pd
          from urllib.parse import quote
          from datetime import datetime

          # --- Config ---
          API_URL = "https://mirabelle.openfoodfacts.org/products.json"
          DATE_STR = datetime.utcnow().strftime("%Y-%m-%d")
          README_PATH = "data/readme.md"

          # --- SQL Query ---
          sql = """

          record_count = len(df)
          csv_filename = f"all_{DATE_STR}_{record_count}.csv"
          csv_path = os.path.join("data", csv_filename)

          os.makedirs("data", exist_ok=True)
          df.to_csv(csv_path, index=False)
          print(f"Saved {record_count} records to {csv_path}")

                  f.write(note)
          else:
              with open(README_PATH, "w", encoding="utf-8") as f:
                  f.write("# Data Log\n\n")
                  f.write("| Date | Record Count | File |\n")
                  f.write("|------|--------------|------|\n")
                  f.write(note)
